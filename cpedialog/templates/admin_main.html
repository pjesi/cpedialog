{% extends "main.html" %}
{% block title %}{{title}} - System Admin{% endblock %}
{% block blogcontainer %}
<!-- Dependency -->
<script src="http://yui.yahooapis.com/2.5.2/build/yahoo/yahoo-min.js"></script>
<!-- Used for Custom Events and event listener bindings -->
<script src="http://yui.yahooapis.com/2.5.2/build/event/event-min.js"></script>
<!-- Connection Manager -->
<script src="http://yui.yahooapis.com/2.5.2/build/connection/connection-min.js"></script>
<!-- JSON Utility -->
<script src="http://yui.yahooapis.com/2.5.2/build/json/json-min.js"></script>
<!--DataTable-->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.5.2/build/datatable/assets/skins/sam/datatable.css" />
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/yahoo-dom-event/yahoo-dom-event.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/element/element-beta-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/datasource/datasource-beta-min.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.2/build/datatable/datatable-beta-min.js"></script>
<!--my yui grid render-->
<script type="text/javascript" src="/jscripts/update.prototype.grid.js"></script>
<script type="text/javascript" src="/jscripts/menulist.grid.js"></script>
<div class="yui-g">
<div id="admincontainer" class=" yui-skin-sam">
<script>
    String.prototype.trim = function () {
        return this.replace(/^[\s\,]*/, "").replace(/[\s\,]*$/, ""); //for remove the space and comma at the begining/end of the tag.
    };
    var handleFailure = function(o) {
        if (o.responseText !== undefined) {
            alert("Client RPC Request Error, please retry.");
        }
    }

    function isInteger(number) {
        for (var i = 0; i < number.length; i++) {
            if (isNaN(number.charAt(i))) {
                return false;
            }
        }
        return true;
    }

    function saveConfiguration(){
        var title = document.forms["configForm"]["title"];
        if(title.value==""){
            alert("Please input blog title.");
            title.focus();
            return false;
        }
        var author = document.forms["configForm"]["author"];
        if(author.value==""){
            alert("Please input author name.");
            author.focus();
            return false;
        }        
        var email = document.forms["configForm"]["email"];
        if(email.value==""){
            alert("Please input email address.");
            email.focus();
            return false;
        }
        var root_url = document.forms["configForm"]["root_url"];
        if(root_url.value==""){
            alert("Please input root url address.");
            root_url.focus();
            return false;
        }
        var num_post_per_page = document.forms["configForm"]["num_post_per_page"];
        if(num_post_per_page.value=="" || !isInteger(num_post_per_page.value)){
            alert("Please input posts num per page.");
            num_post_per_page.focus();
            return false;
        }
        var cache_time = document.forms["configForm"]["cache_time"];
        if(cache_time.value=="" || !isInteger(cache_time.value)){
            alert("Please input page cache time value.");
            cache_time.focus();
            return false;
        }
        var google_ajax_feed_result_num = document.forms["configForm"]["google_ajax_feed_result_num"];
        var google_ajax_feed_title = document.forms["configForm"]["google_ajax_feed_title"];
        if (document.forms["configForm"]["google_ajax_feed_enable"].checked) {
            google_ajax_feed_result_num.disabled = false;
            google_ajax_feed_title.disabled = false;
            if(google_ajax_feed_title.value==""){
                alert("Please input feed control main title.");
                google_ajax_feed_title.focus();
                return false;
            }
            if (google_ajax_feed_result_num.value == "" || !isInteger(google_ajax_feed_result_num.value)) {
                alert("Please input result num per feed.");
                google_ajax_feed_result_num.focus();
                return false;
            }
        }else{
           google_ajax_feed_result_num.disabled = true;
           google_ajax_feed_title.disabled = true;
        }
        var delicious_enable = document.forms["configForm"]["delicious_enable"];
        var delicious_username = document.forms["configForm"]["delicious_username"];
        if (delicious_enable.checked) {
            delicious_username.disabled = false;
            if(delicious_username.value==""){
                alert("Please input del.icio.us username.");
                google_ajax_feed_title.focus();
                return false;
            }
        }else{
            delicious_username.disabled = true;
        }
        var recaptcha_enable = document.forms["configForm"]["recaptcha_enable"];
        var recaptcha_public_key = document.forms["configForm"]["recaptcha_public_key"];
        var recaptcha_private_key = document.forms["configForm"]["recaptcha_private_key"];
        if (recaptcha_enable.checked) {
            recaptcha_public_key.disabled = false;
            recaptcha_private_key.disabled = false;
            if(recaptcha_public_key.value==""){
                alert("Please input recaptcha public key.");
                recaptcha_public_key.focus();
                return false;
            }
            if(recaptcha_private_key.value==""){
                alert("Please input recaptcha private key.");
                recaptcha_private_key.focus();
                return false;
            }
        }else{
            recaptcha_public_key.disabled = true;
            recaptcha_private_key.disabled = true;
        }
        
        var logo_images = document.forms["configForm"]["logo_images"];
        var logoUrls = logo_images.value.replace(/[,\n\r]/g, ' ');
        logoUrls = logoUrls.replace(/[ ]+/g, ' ');
        var logoArray = logoUrls.split(' ');
        var logo_images_space = "";
        for(var i=0;i<logoArray.length;i++){
           logo_images_space+=logoArray[i];
           if(i!=logoArray.length-1){
            logo_images_space+=" ";
           }
        }
        document.forms["configForm"]["logo_images_space"].value = logo_images_space;
        return true;
    }
</script>
<div id="adminmenu">
    <a href="/admin" onfocus="this.blur()">System Configuration</a>  <a href="/admin/more" onfocus="this.blur()">Resource Management</a>
</div>
<fieldset>
    <legend>System configuration</legend>
    <div class="fieldsetdiv">
    <form method=post id="configForm">
    <table cellspacing="0" class="yui-skin-sam" id="configuration">
        <tr>
            <th><label for="title">Blog Title:</label></th>
            <td>
              <input id="title"  name="title" size="30" type="text" value="{{BLOG.title}}" />
            </td>
        </tr>
        <tr>
            <th><label for="author">Author:</label></th>
            <td>
                <input id="author"  name="author" size="15" type="text" value="{{BLOG.author}}" />
                <small id="username_msg">No spaces, please.</small>
                  </td>
        </tr>
        <tr>
            <th><label for="email">Email:</label></th>
            <td><input id="email" name="email" size="30" type="text" value="{{BLOG.email}}" /></td>
        </tr>
        <tr>
            <th><label for="description">Blog Description:</label></th>
            <td><input id="description" name="description" size="60" type="text" value="{{BLOG.description}}" /> </td>
        </tr>
        <tr>
            <th><label for="root_url">Root URL:</label></th>
            <td>
                <input id="root_url" name="root_url" size="30" type="text" value="{{BLOG.root_url}}" />
            </td>
        </tr>
        <tr>
            <th><label for="logo_images">Logo images:</label></th>
            <td>
                <input type="hidden" id="logo_images_space" name="logo_images_space"/>
                <textarea id="logo_images" name="logo_images"  rows="5" cols="50" style="">{% for logo in BLOG.logo_images %}{{logo}}{% if not forloop.last %}
                    {% endif %}{% endfor %}</textarea>
                <p><small>Separate logo images urls with commas and/or newlines. These images will randomly display on the site.</small></p>
            </td>
        </tr>
        <tr>
            <th><label for="num_post_per_page">Posts num per page:</label></th>
            <td>
                <input id="num_post_per_page" name="num_post_per_page" maxlength="15" size="15" type="text" value="{{BLOG.num_post_per_page}}" />
                <p><small>This number is used for the pagination.</small></p>
            </td>
        </tr>
        <tr>
            <th><label for="cache_time">Page Cache Time:</label></th>
            <td>
                <input id="cache_time" name="cache_time" maxlength="15" size="15" type="text" value="{{BLOG.cache_time}}" />
                <p><small>Be careful! This value will make your page unchanging for the specified time.</small></p>
            </td>
        </tr>
        <tr>
            <th><label for="debug">Debug Mode:</label></th>
            <td>
                <input id="debug" name="debug" type="checkbox" {% if BLOG.debug %} checked {% endif %}/>
                <p><small>You can get more detailed log info in appengine when enable debug mode.</small></p>
            </td>
        </tr>
        <tr>
            <th><label for="recaptcha_enable">Recaptcha enable:</label></th>
            <td>
                <input id="recaptcha_enable" name="recaptcha_enable" type="checkbox" {% if BLOG.recaptcha_enable %} checked {% endif %}/>
                <p><small>reCAPTCHA is a free CAPTCHA service that helps to digitize books.  </small></p>
                <p><small>You can get reCAPTCHA from: <a href="http://recaptcha.net/">http://recaptcha.net/</a>. </small></p>
            </td>
        </tr>
        <tr>
            <th><label for="recaptcha_public_key">Recaptcha public key:</label></th>
            <td>
                <input id="recaptcha_public_key" name="recaptcha_public_key"  size="60" type="text" value="{{BLOG.recaptcha_public_key}}"/>
            </td>
        </tr>
        <tr>
            <th><label for="recaptcha_private_key">Recaptcha private key:</label></th>
            <td>
                <input id="recaptcha_private_key" name="recaptcha_private_key"  size="60" type="text" value="{{BLOG.recaptcha_private_key}}"/>
            </td>
        </tr>
        <tr>
            <th><label for="delicious_enable">del.icio.us enable:</label></th>
            <td>
                <input id="delicious_enable" name="delicious_enable" type="checkbox" {% if BLOG.delicious_enable %} checked {% endif %}/>
                <p><small>Delicious is a Social Bookmarking service. </small></p>
            </td>
        </tr>
        <tr>
            <th><label for="delicious_username">del.icio.us username:</label></th>
            <td>
                <input id="delicious_username" name="delicious_username"  size="15" type="text" value="{{BLOG.delicious_username}}"/>
                <small>You can get del.icio.us from: <a href="http://delicious.com/">http://delicious.com/</a> </small>
            </td>
        </tr>
        <tr>
            <th><label for="google_ajax_feed_enable">Feed control enable:</label></th>
            <td>
                <input id="google_ajax_feed_enable" name="google_ajax_feed_enable" type="checkbox"  {% if BLOG.google_ajax_feed_enable %} checked {% endif %}/>
                <small>Enable feed control on your site.</small>
                <p><small>You can manager your feeds on the <a href="/admin/more">resource management</a> module.</small></p>
            </td>
        </tr>
        <tr>
            <th><label for="google_ajax_feed_title">Feed control main title:</label></th>
            <td>
                <input id="google_ajax_feed_title" name="google_ajax_feed_title"  size="30" type="text" value="{{BLOG.google_ajax_feed_title}}"/>
            </td>
        </tr>
        <tr>
            <th><label for="google_ajax_feed_result_num">Result num per feed:</label></th>
            <td>
                <input id="google_ajax_feed_result_num" name="google_ajax_feed_result_num" maxlength="15" size="15" type="text" value="{{BLOG.google_ajax_feed_result_num}}"/>
            </td>
        </tr>
        <tr>
            <th> </th>
            <td><input name="commit" type="submit" value="Save" onclick="return saveConfiguration()"/></td>
        </tr>
    </table>
    </form>
    </div>
</fieldset>
<fieldset>
    <legend>Page Admin</legend>
    <div class="fieldsetdiv">
        Page List:
        <table id="pagetable">
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Date</th>
                <th>Permalink</th>
                <th> &nbsp;</th>
            </tr>
            {% for entry in pages %}
            <tr>
                <td>{{entry.title}}</td>
                <td>{{entry.author.email}}</td>
                <td>{{entry.date|date:"m/d/y"}}</td>
                <td>
                    <a href="{{entry.full_permalink}}" target="_blank">{{entry.full_permalink}}</a>
                </td>
                <td>
                    <a href='/editBlog?blogId={{entry.key.id}}' target="_blank">edit</a> &nbsp;
                    <a href='/deleteBlog?blogId={{entry.key.id}}' target="_blank">delete</a>
                </td>
            </tr>
            {% endfor%}
        </table>
    </div>
</fieldset>
<fieldset>
    <legend>Menu Admin</legend>
    <div class="fieldsetdiv">
        Menu List:
            <div id="menudiv">
            <table id="menutable">
                <thead><tr>
                    <th>Title</th>
                    <th>Permalink</th>
                    <th>Target</th>
                    <th>Order</th>
                    <th>Valid</th>
                    <th>Id</th>
                    <th>Delete</th>
                    <th>Add</th>
                </tr></thead>
                <tbody>
                {% for entry in menus %}
                <tr id="menu_{{entry.key.id}}">
                    <td>{{entry.title}}</td>
                    <td>{{entry.permalink}}</td>
                    <td>{{entry.target}}</td>
                    <td>{{entry.order}}</td>
                    <td>{{entry.valid}}</td>
                    <td>{{entry.key.id}}</td>
                    <td> </td>
                    <td> </td>
                </tr>
                {% endfor%}
                </tbody>
            </table>
            </div>
    </div>
</fieldset>
<fieldset>
    <legend>Session Token Management</legend>
    <div class="fieldsetdiv">
        Sesseion Token List:
        <table id="tokentable">
            <tr>
                <th>User Email</th>
                <th>Target Service</th>
                <th>Session Token</th>
                <th> &nbsp;</th>
            </tr>
            {% for token in session_tokens %}
            <tr>
                <td>{{token.user_email}}</td>
                <td>{{token.target_service}}</td>
                <td>{{token.session_token}}</td>
                <td>
                    <a href="javascript:deleteSessionToken('{{token.user_email}}','{{token.target_service}}')"
                       id="{{token.user_email}}_{{token.target_service}}">Delete</a>
                </td>
            </tr>
            {% endfor%}
        </table>
    </div>
    <script>
        function deleteSessionToken(user_email, target_service) {
            var sUrl = "/rpc?action=DeleteSessionToken&arg0=\"" + user_email + "\"&arg1=\"" + target_service +
                       "\"&time=" + new Date().getTime();
            var deleteSessionTokenSuccess = function(o) {
                if (o.responseText !== undefined) {
                    var src_obj = document.getElementById(o.argument.user_email + "_" + o.argument.target_service);
                    document.getElementById("tokentable").deleteRow(src_obj.parentNode.parentNode.rowIndex);
                    alert("Delete session token successfully.");
                }
            }
            var callback =
            {
                success:deleteSessionTokenSuccess,
                failure:handleFailure,
                argument:{user_email:user_email,target_service:target_service}
            };
            YAHOO.util.Connect.asyncRequest('GET', sUrl, callback);
        }
    </script>
</fieldset>
<fieldset>
    <legend>System Cache Management</legend>
    <div class="fieldsetdiv">
        Memcache statistics for this application:
        <table>
            <tr>
                <th>hits</th>
                <td><span id="cache_stats.hits">{{cache_stats.hits}}</span></td>
                <td><span class="fieldsetcomment">Number of cache get requests resulting in a cache hit.</span>
                </td>
            </tr>
            <tr>
                <th>misses</th>
                <td><span id="cache_stats.misses">{{cache_stats.misses}}</span></td>
                <td><span class="fieldsetcomment">Number of cache get requests resulting in a cache miss.</span>
                </td>
            </tr>
            <tr>
                <th>byte_hits</th>
                <td><span id="cache_stats.byte_hits">{{cache_stats.byte_hits}}</span></td>
                <td><span class="fieldsetcomment">Sum of bytes transferred on get requests. Rolls over to zero on overflow.</span>
                </td>
            </tr>
            <tr>
                <th>items</th>
                <td><span id="cache_stats.items">{{cache_stats.items}}</span></td>
                <td><span class="fieldsetcomment">Number of key/value pairs in the cache. </span></td>
            </tr>
            <tr>
                <th>bytes</th>
                <td><span id="cache_stats.bytes">{{cache_stats.bytes}}</span></td>
                <td><span class="fieldsetcomment">Total size of all items in the cache.</span></td>
            </tr>
            <tr>
                <th>oldest_item_age</th>
                <td><span id="cache_stats.oldest_item_age">{{cache_stats.oldest_item_age}}</span></td>
                <td><span class="fieldsetcomment">How long in seconds since the oldest item in the cache was accessed.
                        Effectively, this indicates how long a new item will survive in the cache without being
                        accessed. This is _not_ the amount of time that has elapsed since the item was created.</span>
                </td>
            </tr>
        </table>
        <br>
        <a href="javascript:flushAllMemcache(false);">Refresh Memcache statistics</a> &nbsp; &nbsp;
        <a href="javascript:flushAllMemcache(true);">Flush All the Memcache</a>
    </div>
    <script>
        function flushAllMemcache(flush) {
            var sUrl = "/rpc?action=FlushAllMemcache&arg0=" + flush + "&time=" + new Date().getTime();
            var flushAllMemcacheSuccess = function(o) {
                if (o.responseText !== undefined) {
                    var cache_stats = YAHOO.lang.JSON.parse(o.responseText);
                    document.getElementById("cache_stats.hits").innerHTML = cache_stats.hits;
                    document.getElementById("cache_stats.misses").innerHTML = cache_stats.misses;
                    document.getElementById("cache_stats.byte_hits").innerHTML = cache_stats.byte_hits;
                    document.getElementById("cache_stats.items").innerHTML = cache_stats.items;
                    document.getElementById("cache_stats.bytes").innerHTML = cache_stats.bytes;
                    document.getElementById("cache_stats.oldest_item_age").innerHTML = cache_stats.oldest_item_age;
                    if (o.argument.flush) {
                        alert("Flush all the memcache successfully.");
                    } else {
                        alert("Refresh memcache statistics successfully.");
                    }
                }
            }
            var callback =
            {
                success:flushAllMemcacheSuccess,
                failure:handleFailure,
                argument:{flush:flush}
            };
            YAHOO.util.Connect.asyncRequest('GET', sUrl, callback);
        }
    </script>
</fieldset>
</div>
</div>
{% endblock %}

